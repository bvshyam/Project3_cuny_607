library(plyr)
library(tidyr)
library(dplyr)
library(stringr)
library(lubridate)
library(RMySQL)

chicago <- read.csv("https://raw.githubusercontent.com/bvshyam/Project3_cuny_607/master/Data/chicago_dec2015.csv", header=TRUE, sep=",", stringsAsFactors = FALSE,na.strings = c("",NA,"n/a","N/A","NA"))


table(chicago$Primary.Type)

groupedCrimes <- chicago %>% group_by(Primary.Type, Arrest) %>% summarise(Total=n())

arrestOnly <- filter(groupedCrimes, Arrest %in% "true")

arrestOnly

noArrest <- filter(groupedCrimes, Arrest %in% "false")

noArrest

groupedCrimesByLocation <- chicago %>% group_by(Primary.Type, Arrest, Location.Description) %>% summarise(Total=n())

arrestOnly <- filter(groupedCrimesByLocation, Arrest %in% "true")

arrestOnly

arrestOnly[which.max(arrestOnly$Total),]

noArrest <- filter(groupedCrimesByLocation, Arrest %in% "false")

noArrest

noArrest[which.max(noArrest$Total),]


crimeDates <- as.Date(chicago$Date, "%m/%d/%Y")
chicagoTimes <- unlist(str_extract_all(chicago$Date, pattern="\\d{1,2}\\:\\d{1,2}\\:\\d{1,2}"))
partOfDay <- unlist(str_extract_all(chicago$Date, pattern="[[:alpha:]]{2}"))
dayOfWeek <- wday(crimeDates, label = TRUE)
crimeMonth <- month(crimeDates, label = TRUE)
crimeTimeStamp <- hms(chicagoTimes)
crimeHr <- hour(crimeTimeStamp)
crimeMin <- minute(crimeTimeStamp)
crimeSec <- second(crimeTimeStamp)


cleanedData <- data.frame(
crimeType = chicago$Primary.Type,
wasArrestMade = chicago$Arrest,
district = chicago$District,
location = chicago$Location.Description,
crimeDates,
dayOfWeek,
crimeMonth,
crimeHr,
crimeMin,
crimeSec,
latitude = chicago$Latitude,
longitude =chicago$Longitude
)


cleanedData$offenseid <- chicago$ID
cleanedData$offenselocaltime <- chicagoTimes


dataForDB <- data.frame (
cityCode = "CHI",
offenseid = cleanedData$offenseid,
offense = cleanedData$crimeType,
offenselocaldate =cleanedData$crimeDates,
offenselocaltime = cleanedData$offenselocaltime,
offensehour= cleanedData$crimeHr,
offensemonth= cleanedData$crimeMonth,
offensearea = cleanedData$location
)

dataForDB$dayofweek <- weekdays(as.Date(crimeDates))

dataForDB <- dataForDB[c(1,2,3,4,5,9,6,7,8)]

conn <- dbConnect(MySQL(),
                 user = 'mygroup',
                 password = 'mygroup#01',
                 host = 'mygroup.c5rotlbjbl71.us-east-1.rds.amazonaws.com',
                 dbname = 'crimedb')

dbWriteTable(conn, value = dataForDB, name = "crimedata", row.names=F, append = TRUE ) 
