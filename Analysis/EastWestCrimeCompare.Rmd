---
title: "607 Project 3 : Crime Compare"
author: "Kumudini Bhave, Shyam BV, Mark Halpin, Upal Chowdhury"
date: "October 18, 2016"
output:
  html_document:
    toc: yes
---


********

# **Crime DataSet Study : Crime Data Study , a comparison between East Coast city , New York City (NYC) and West Coast city San Francisco (SFO) and MidWest city Chicago (CHI)**

********

## Summary

This is an R Markdown document for providing documentation for performing **Data Exploration And Analysis Of the Crime  DataSet of publicly available crime data for New York City and San Francisco and Chicago**

********

## R Code :

### Loading Packages Used


```{r warning=FALSE, comment=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=150)}
knitr::opts_chunk$set(message = FALSE, echo=TRUE)

# Library for string manipulation/regex operations
library(stringr)
# Library for data display in tabular format
library(DT)
# Library to read text file
library(RCurl)
# Library to gather (to long format) and spread (to wide format) data, to tidy data
library(tidyr)
# Library to filter, transform data
library(dplyr)
# Library to plot
library(ggplot2)
library(knitr)


# Library for db operations
library(RMySQL)


# Library for loading data
library(jsonlite)
library(XML)
library(xml2)

```

********

### Function to get database connection 

```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}


mysql_dbconn <- function(schema, uid, hostname, pwd){
  
     rmysql.settingsfile<-"C:/ProgramData/MySQL/MySQL Server 5.6/my.ini"
     conn <- dbConnect(RMySQL::MySQL(), dbname = schema, username=uid , host = hostname, password = pwd)
     return(conn)          
}



```


********

### Forming MYSQL DB Connection to Crime Schema

```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}


#conn <- mysql_dbconn("crime","root","WhiteLotus21")
#conn <- mysql_dbconn('mygroup','mygroup#01','mygroup.c5rotlbjbl71.us-east-1.rds.amazonaws.com','crimedb')



conn <- dbConnect(MySQL(),
                 user = 'mygroup',
                 password = 'mygroup#01',
                 host = 'mygroup.c5rotlbjbl71.us-east-1.rds.amazonaws.com',
                 dbname = 'crimedb')


# List the database tables in crime schema
entdbtables <- dbListTables(conn)

```


********




********




###  New York City (NYC) DataSet Study


#### Loading New York City (NYC) DataSet

Loading the crime data. Reading data file , XML format, from the GitHub location with Header as True

https://raw.githubusercontent.com/bvshyam/Project3_cuny_607/master/Data/NYC_15.csv

 
```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}


################################ XML #######################################

nycxml.giturl <- "https://raw.githubusercontent.com/bvshyam/Project3_cuny_607/master/Data/nyc_dec2015.xml"
nycdataxml <- xmlRoot(xmlParse(getURL(nycxml.giturl))) # get XML file contents
class(nycdataxml)
xmlName(nycdataxml)
xmlSize(nycdataxml)
nycdataxml[1]
xmlSize(nycdataxml[1])
xmlSize(nycdataxml[[1]])

nycdataxmlDFchk <- xmlToDataFrame(nycdataxml[[1]])
nrow(nycdataxmlDFchk)
head(nycdataxmlDFchk)

# select columns from the dataset for study

nyc_crimedataDF <- nycdataxmlDFchk %>% select(objectid, occurrence_date,day_of_week,occurrence_month,occurrence_hour,offense, borough)


# mutate to strip time

nyc_crimedataDF <- nyc_crimedataDF %>% 
     mutate(occurrence_time = str_extract(occurrence_date,"[[:digit:]]{2}:[[:digit:]]{2}:[[:digit:]]{2}")) %>% mutate(occurrence_date = str_extract(occurrence_date, "[[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2}")) %>% 
     mutate(occurrence_hour = as.numeric(occurrence_hour))

     

# mutate to add Week# from (0 - 52)

nyc_crimedataDF <- nyc_crimedataDF %>% mutate(week = strftime(as.POSIXlt(occurrence_date),format="%W"))

datatable(nyc_crimedataDF)


#x<-head(nyc_crimedataDF)

#xm <- x %>% mutate(occurrence_time = str_extract(occurrence_date,"[[:digit:]]{2}:[[:digit:]]{2}:[[:digit:]]{2}")) %>% #mutate(occurrence_date = str_extract(occurrence_date, "[[:digit:]]{4}-[[:digit:]]{2}-[[:digit:]]{2}"))
     

```


********

#### Populating CimeData database table with New York City (NYC) Crime Data



 
```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}

# Prepare dataframe for database insert

nycdbinsert <- subset(nyc_crimedataDF, select = c(objectid, offense, occurrence_date, occurrence_time ,day_of_week,occurrence_hour, occurrence_month, borough))


     
# Adding citycode column at start of dataframe
nycdbinsert <- cbind(citycode = "NYC", nycdbinsert)


# matching column names to database table column names

colnames(nycdbinsert) <- c( "citycode", "offenseid", "offense", "offenselocaldate", "offenselocaltime", "dayofweek", "offensehour", "offensemonth", "offensearea" )
     
# Bulk insert from dataframe to MYSQL table

dbWriteTable(conn, value = nycdbinsert, name = "crimedata", row.names=F, append = TRUE ) 


#View(nycdbinsert)

  


```

*********






*********



#### new df <- group by bourough and offense
group by borough andwithin borough, group by offense

 
```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}

     nyc_crimedata_boroughDF <- nyc_crimedataDF %>% select( borough, offense) %>% group_by(borough, offense) %>%  dplyr::summarise(total =n())

datatable(nyc_crimedata_boroughDF)
```

********
#### new df <- group by week# and offense

```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}

nyc_crimedata_weekDF <- nyc_crimedataDF %>% select( week, offense) %>% group_by(week, offense) %>%  dplyr::summarise(total =n())

datatable(nyc_crimedata_weekDF)

```

#### new df <- group by hour# and offense

```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}

nyc_crimedata_hourDF <- nyc_crimedataDF %>% select( occurrence_hour, offense) %>% group_by(occurrence_hour, offense) %>%  dplyr::summarise(total =n()) %>% arrange(occurrence_hour)

nyc_crimedata_hourrateDF <- nyc_crimedata_hourDF %>% select( occurrence_hour, total) %>%  group_by(occurrence_hour)  %>%  dplyr::summarise(offensecount = sum(total))%>% arrange(occurrence_hour)

datatable(nyc_crimedata_hourDF)

```




### NYC DataSet Plots

Hour vs Offense
```{r warning=FALSE, comment=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=120), fig.width=10,fig.height=10}



ggplot(nyc_crimedata_hourDF, aes(y=nyc_crimedata_hourDF$total, x= nyc_crimedata_hourDF$occurrence_hour)) + geom_point(aes(color=offense)) + ggtitle("Hypothesis : Offense Vs Hour Of Day") + facet_grid(~offense) + xlab("Hour Of Day") +  ylab("Offense") 




```





# Day vs hour 



# Day vs Offense

```{r warning=FALSE, comment=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=120), fig.width=10,fig.height=10}


nyc_crimedata_dayDF <- nyc_crimedataDF %>% select( day_of_week, offense) %>% group_by(day_of_week, offense) %>%  dplyr::summarise(daywisetotal =n())

datatable(nyc_crimedata_dayDF)

ggplot(nyc_crimedata_dayDF, aes(y=daywisetotal, x= day_of_week, fill= offense)) + xlab("Day Of Week") + ylab("Offense Count") + ggtitle("Hypothesis : Offense Vs Day Of Week") + geom_bar(stat="identity", position=position_dodge()) + scale_fill_brewer(palette="OrRd") + scale_x_discrete(limits=c("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday", "Saturday"))




```

# hour vs borough





# offense vs borough

```{r warning=FALSE, comment=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=120), fig.width=10,fig.height=10}


ggplot(nyc_crimedata_boroughDF, aes(x=nyc_crimedata_boroughDF$borough, y= nyc_crimedata_boroughDF$total, fill= nyc_crimedata_boroughDF$offense)) + ggtitle("Offense In NYC Boroughs") + geom_bar(colour="black",stat='identity') + coord_flip() + xlab("Boroughs") +  ylab("Offense") + scale_fill_brewer(palette="RdPu")

########################################
# Trying map

library(ggmap)
mymap <- get_map(location = "New York", maptype = "roadmap")
ggmap(mymap)

########################################

```

*********
###   San Francisco (SFO) DataSet Study


#### Loading San Francisco (SFO) DataSet

*********







*********

### Chicago (CHI) DataSet Study


*********

#### Loading Chicago (CHI) DataSet


*********


********

### Comparing Crime Across USA Prime Cities

********



********

### Loading Captured Crime Data From All Cities 

Loading crime data captured for different US cities, EastCoast NYC, WestCoast SFO and MidWest Chicago.

```{r tidy=TRUE, tidy.opts=list(width.cutoff=80), echo=TRUE}
#DATE_FORMAT(offenselocaltime,'%H:%i:%s')

if(isIdCurrent(conn))
{
     allcitycrimedata <-  dbGetQuery(conn,"select crimedata.citycode, offenseid, offense, offenselocaldate, offenselocaltime, dayofweek, offensehour, offensemonth, offensearea from crimedata, city where city.citycode = crimedata.citycode")
    
     
     View(allcitycrimedata)
    
     
     action <- dbGetQuery(conn,"select distinct offense from crimedata where citycode='NYC'")

        
     
 for (i in seq(1,nrow(allcitycrimedata),1)) 
{    

      if(grepl('LARCENY|ROBBERY|THEFT|STOLEN|EMBEZZLEMENT', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
           allcitycrimedata$category[i] <- 'LARCENY'
     }
      else if(grepl('RAPE|SEX OFFENSE|SEXUAL|BATTERY|PROSTITUTION', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
         allcitycrimedata$category[i] <- 'SEX OFFENSE'
     }
      
      else if(grepl('BURGLARY', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
           allcitycrimedata$category[i] <- 'BURGLARY'
      }
       else if(grepl('MURDER|HOMICIDE', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
          allcitycrimedata$category[i] <- 'MURDER'
      }
      else if(grepl('NARCOTIC|LIQUOR', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
          allcitycrimedata$category[i] <- 'NARCOTIC'
      }
      else if(grepl('OTHER|SUICIDE|NON CRIMINAL|NON-CRIMINAL|NON - CRIMINAL|SUSPICIOUS|DECEPTIVE|INTERFERENCE|INTIMIDATION|STALKING|TRESSPASS|SECONDARY|RUNAWAY|MISSING|TRESPASS', allcitycrimedata$offense[i], ignore.case=TRUE ))
     {
       allcitycrimedata$category[i] <- 'OTHER'
     }
     else if( grepl('FORGERY|FRAUD|BAD CHECKS|EXTORTION', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
           allcitycrimedata$category[i] <- 'FRAUD'
      }
     else if( grepl('PUBLIC INDECENCY|OBSCENITY|DRUNKENNESS|CONDUCT|PUBLIC PEACE|WARRANTS|WEAPON|VEHICLE|LICENSE|DRIVING|BRIBERY|GAMBLING', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
          allcitycrimedata$category[i] <- 'MISCONDUCT'
      }
       else if( grepl('FAMILY|KIDNAPPING', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
         allcitycrimedata$category[i] <- 'FAMILY'
      } 
      else if( grepl('CHILDREN', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
          allcitycrimedata$category[i] <- 'CHILD ABUSE'
       }
       else if( grepl('VANDALISM|DAMAGE|ARSON', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
          allcitycrimedata$category[i] <- 'VANDALISM'
      }
      else if( grepl('ASSAULT', allcitycrimedata$offense[i], ignore.case=TRUE ))
      {
          allcitycrimedata$category[i] <- 'ASSAULT'
      }
     
 }      # end of for loop
      
      
#   ifany <- any(is.na(allcitycrimedata$category   ))
      
     
      #filter(mtcars, !grepl('Toyota|Mazda', type))
 }
     
     head(allcitycrimedata)
     

```



********


#### new df <- group by city and offense
group by borough andwithin borough, group by offense

 
```{r  tidy=TRUE, tidy.opts=list(width.cutoff=80),echo=TRUE}

     crimedata_cityDF <- allcitycrimedata %>% select( citycode, category) %>% group_by(citycode, category) %>%  dplyr::summarise(total =n())

datatable(crimedata_cityDF)
```


# offense vs city

```{r warning=FALSE, comment=FALSE, message=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=120), fig.width=10,fig.height=10}


ggplot(crimedata_cityDF, aes(x=crimedata_cityDF$citycode, y= crimedata_cityDF$total, fill= crimedata_cityDF$category)) + ggtitle("Offense In US Cities(East Coast, MidWest, WestCoast") + geom_bar(colour="black",stat='identity') + coord_flip() + xlab("Cities") +  ylab("Offense Category") + scale_fill_brewer(palette="Paired")

```



********


### Close database connection     

```{r tidy=TRUE, tidy.opts=list(width.cutoff=80), echo=TRUE}
       
dbDisconnect(conn)

#####################################################################
```
